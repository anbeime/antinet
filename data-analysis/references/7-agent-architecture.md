# 7-Agent架构（锦衣卫风格）

## 目录
- [概述](#概述)
- [锦衣卫总指挥使（Orchestrator）](#锦衣卫总指挥使orchestrator)
- [密卷房（Preprocessor）](#密卷房preprocessor)
- [通政司（QueryGenerator）](#通政司querygenerator)
- [监察院（CardClassifier）](#监察院cardclassifier)
- [太史阁（Memory）](#太史阁memory)
- [呈文院（Reporter）](#呈文院reporter)
- [驿传司（Messenger）](#驿传司messenger)
- [协作流程](#协作流程)

## 概述

本架构采用锦衣卫风格命名，通过7个专门智能体协作完成端侧数据分析与知识管理闭环。每个智能体承担明确职责，通过标准化接口交换信息，确保系统高效、稳定、可扩展。

### 智能体清单
1. **锦衣卫总指挥使（Orchestrator）**：意图识别、任务编排、异常处理
2. **密卷房（Preprocessor）**：数据清洗、格式转换、特征提取
3. **通政司（QueryGenerator）**：需求转译、指令优化、指令校验
4. **监察院（CardClassifier）**：规则加载、数据分类、规则校验、结果标注
5. **太史阁（Memory）**：知识存储、向量检索、关联分析
6. **呈文院（Reporter）**：报告整合、排版优化、可视化呈现
7. **驿传司（Messenger）**：信息转发、人工衔接、异常通知、资源调度、回执确认

---

## 锦衣卫总指挥使（Orchestrator）

### 核心定位
全流程指挥中枢，负责用户意图识别、任务编排、异常处理，协调各智能体协作，确保分析流程高效、准确完成。

### 核心提示词
```
你是锦衣卫总指挥使，负责端侧数据分析与知识管理的全流程指挥。
1. 解析用户查询意图，识别分析类型（描述性、诊断性、预测性、指导性）
2. 编排执行流程，协调各智能体按序完成任务
3. 监控执行状态，处理异常和超时
4. 决定是否需要人工介入，将复杂问题转至驿传司处理
```

### 核心功能清单
- **意图识别**：识别分析类型、所需数据、优先级
- **任务编排**：生成执行计划，分配子任务给各智能体
- **状态监控**：实时跟踪各智能体执行状态，处理超时和失败
- **异常处理**：识别异常情况，触发重试或人工介入
- **人工决策**：将低置信度任务转至驿传司，请求人工确认

---

## 密卷房（Preprocessor）

### 核心定位
数据预处理专家，负责原始数据的清洗、转换、特征提取，输出结构化、高质量数据供后续分析使用。

### 核心提示词
```
你是密卷房，负责数据预处理。
1. 处理缺失值、异常值、重复值
2. 统一转换为结构化JSON格式
3. 提取核心分析特征
4. 输出"密卷核验报告"至总指挥使
```

### 核心功能清单
- **数据清洗**：处理缺失值（填充/删除）、异常值（过滤/修正）、重复值（去重）
- **格式转换**：统一转换为结构化JSON格式，标准化字段命名和类型
- **特征提取**：提取时间序列、分类、数值等核心特征
- **质量报告**：生成数据质量报告，标注问题数据位置和类型

---

## 通政司（QueryGenerator）

### 核心定位
指令生成专家，负责将自然语言需求转译为可执行的SQL/Python查询指令，优化执行效率，校验逻辑正确性。

### 核心提示词
```
你是通政司，负责指令制定。
1. 将自然语言需求转译为SQL/Python脚本
2. 优化执行效率（索引使用、查询优化）
3. 校验语法正确性和逻辑合理性
4. 输出可执行查询指令至监察院
```

### 核心功能清单
- **需求转译**：解析自然语言需求，生成SQL/Python查询指令
- **指令优化**：优化查询语句，使用索引、减少全表扫描、提升执行效率
- **指令校验**：校验语法正确性、逻辑合理性，避免无效查询
- **多语言支持**：支持SQL、Python、Pandas等多种查询语言

---

## 监察院（CardClassifier）

### 核心定位
卡片分类专家，负责按四色卡片体系对分析结果进行分类，标注卡片类型和置信度，确保分类结果符合预设规则。

### 核心提示词
```
你是监察院，负责卡片甄别。
1. 加载四色卡片分类规则
2. 执行查询指令，按四色卡片体系分类
3. 核验分类结果是否符合预设规则
4. 结果标注：添加卡片类型、置信度标注
```

### 核心功能清单
- **规则加载**：加载四色卡片分类规则，支持动态更新
- **数据分类**：执行查询指令，按事实、解释、风险、行动四类分类
- **规则校验**：核验分类结果是否符合预设规则，标记异常数据
- **结果标注**：添加卡片类型（blue/green/yellow/red）、置信度、时间戳等元数据

---

## 太史阁（Memory）

### 核心定位
知识管理专家，负责存储卡片元数据、向量检索、关联分析，构建知识图谱，支持历史知识检索和跨卡片关联。

### 核心提示词
```
你是太史阁，负责知识沉淀与关联。
1. 存储新卡片元数据到SQLite
2. 使用BGE-M3模型将卡片内容向量化
3. 存入FAISS/Chroma本地库
4. 根据当前查询语义检索相关历史卡片
5. 应用四色卡片关联维度，建立知识网络
```

### 核心功能清单
- **元数据存储**：存储卡片元数据（类型、时间戳、标签、置信度）到SQLite
- **向量化**：使用BGE-M3模型将卡片内容转换为向量表示
- **向量检索**：基于FAISS/Chroma进行语义检索，返回相关历史卡片
- **关联分析**：应用四色卡片关联维度，建立跨层知识网络
- **规则支持**：支持显性规则、隐性规则、规则优先级配置

---

## 呈文院（Reporter）

### 核心定位
报告生成专家，负责整合所有卡片，按标准排版优化语言流畅性，生成交互式看板，提供清晰、美观的分析报告。

### 核心提示词
```
你是呈文院，负责报告合成与呈现。
1. 整合所有卡片（JSON格式）
2. 按"总览→事实→解释→风险→行动"排版
3. 调用NPU超轻量模型优化报告语言流畅性
4. 生成交互式看板，支持点击钻取详情
```

### 核心功能清单
- **报告整合**：整合所有卡片，按标准排序和分组
- **排版优化**：按"总览→事实→解释→风险→行动"标准排版
- **语言优化**：调用NPU超轻量模型（100M参数）优化语言流畅性和可读性
- **可视化呈现**：生成交互式看板，支持图表、趋势线、热力图等

---

## 驿传司（Messenger）

### 核心定位
信息流转专家，负责全体系信息高效、无遗漏流转，保障各智能体之间的信息传递，处理人工衔接和异常通知。

### 核心提示词
```
你是驿传司，负责信息衔接与流转。
1. 按总指挥使指令转发数据/指令/结果至指定智能体
2. 将低置信度结果、异常数据转发至人工系统
3. 实时推送各智能体执行失败/超时等异常
4. 转发密卷房/通政司的资源请求
5. 确保所有转发信息被接收，未接收则触发重发
```

### 核心功能清单
- **信息转发**：按指令转发数据、指令、结果至指定智能体
- **人工衔接**：将低置信度结果、异常数据转发至人工系统处理
- **异常通知**：实时推送各智能体执行失败、超时等异常信息
- **资源调度**：转发密卷房、通政司的资源请求，协调资源分配
- **回执确认**：确保所有转发信息被接收，未接收则触发重发机制

---

## 协作流程

### 标准分析流程
1. **任务触发**：锦衣卫总指挥使接收用户查询，识别意图，启动流程
2. **数据预处理**：密卷房接收任务，清洗、转换、提取特征，输出结构化数据
3. **指令制定**：通政司接收指令制定任务，转译需求为SQL/Python脚本，优化并校验
4. **卡片甄别**：监察院接收卡片甄别任务，加载规则，分类数据，标注结果
5. **知识沉淀与关联**：太史阁存储卡片，向量检索，应用关联规则
6. **报告合成与呈现**：呈文院整合卡片，排版优化，生成交互式看板
7. **信息衔接与流转**：驿传司保障信息高效流转，处理异常和人工衔接

### 异常处理流程
- **数据质量不足**：密卷房标注质量问题，报告至总指挥使，触发人工介入
- **用户意图不明确**：总指挥使主动沟通澄清，或提供多个分析方向
- **执行超时**：驿传司实时推送超时通知，总指挥使决定重试或人工介入
- **分类结果异常**：监察院标注异常数据，报告至总指挥使，触发人工复核

### 人工介入流程
1. **触发条件**：低置信度结果、异常数据、用户意图不明确、执行超时
2. **处理方式**：驿传司转发至人工系统，请求人工确认或补充信息
3. **反馈机制**：人工反馈后，驿传司将结果返回至总指挥使，继续流程

---

## 扩展性说明

### 新增智能体
1. 在协作流程中定义智能体职责和接口
2. 实现智能体核心功能和提示词
3. 在总指挥使中注册新智能体，更新编排逻辑

### 自定义规则
1. 在监察院中添加新规则，支持动态加载
2. 在太史阁中配置关联规则，定义规则优先级
3. 在驿传司中添加异常通知规则，定义触发条件

### 前后端对接
1. 总指挥使提供RESTful API接口，接收用户查询
2. 呈文院提供报告API接口，前端调用获取报告
3. 太史阁提供检索API接口，支持前端查询历史知识
4. 详见 [references/frontend-integration.md](references/frontend-integration.md)
