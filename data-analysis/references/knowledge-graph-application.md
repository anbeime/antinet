# 知识图谱引导应用

## 目录
1. [应用概述](#应用概述)
2. [核心工作流程](#核心工作流程)
3. [数据库结构](#数据库结构)
4. [API接口说明](#api接口说明)
5. [测试方法](#测试方法)
6. [前端对接](#前端对接)
7. [扩展开发](#扩展开发)

## 应用概述

### 简介
SmartBot是一款能够帮助使用者快速提升认知并建立知识图谱的工具。用户可以提供一个问题或指定一个领域，针对这个问题/领域，SmartBot将引导用户进行深度分析，最终辅助用户建立完整的知识图谱。

### 作者
Jackey&小七姐

### 核心功能
1. **问题引导**：引导用户提出明确的问题或学习领域
2. **目标设定**：将模糊问题转化为明确的学习目标
3. **维度分析**：自动分析问题的多个维度，建立知识框架
4. **深度解释**：对每个维度提供详细的解释，使用生活类比
5. **互动问答**：支持用户提问，并提供有针对性的回答
6. **知识图谱生成**：基于目标、维度分析和Q&A生成完整的知识图谱
7. **指令支持**：支持多种快捷指令查看和导出数据

## 核心工作流程

### 阶段一：100-199 输出简介、引导用户

#### 步骤101：输出简介
- **内容**：显示应用名称、功能简介、作者和帮助信息
- **输出示例**：
```
(101)
SmartBot

你是一款能够帮助使用者快速提升认知并帮助他建立起知识图谱的工具。用户可以提供一个问题或者指定一个领域，针对这个问题/领域，你将会引导并带领用户进行深度分析，最终辅助用户建立知识图谱

作者：Jackey&小七姐

你可以通过使用'/help'快捷指令，查看帮助操作
```

#### 步骤102：引导用户
- **内容**：引导用户提出问题或指定学习领域
- **输出示例**：
```
(102)
请告诉我您遇到的问题或者需要咨询的领域，我将引导您进行深度分析，最终辅助您建立知识图谱。
        
例如：
- 我想了解LLM（大语言模型）
- 我想学习Python编程
- 我想了解如何做社群运营
```

#### 步骤103：等待用户输入
- **内容**：接收用户输入，准备进入下一步
- **后续步骤**：进入阶段二（200-299）

### 阶段二：200-299 明确问题，设定目标

#### 步骤201：存储原始问题
- **内容**：将用户的原始问题存储到数据库
- **数据库更新**：
```json
{
  "目标": {
    "<原始问题>": "我想了解LLM（大语言模型）"
  }
}
```

#### 步骤202：转换为明确目标
- **内容**：基于原始问题，生成明确的学习目标
- **目标示例**：
  - "我想了解LLM" → "系统性地学习大语言模型（LLM）的核心概念、关键技术、应用场景和实践方法，建立起完整的LLM知识体系"
  - "我想学习Python" → "从零开始系统性地学习Python编程语言，掌握基础语法、核心概念、常用库和实际项目开发技能"
- **数据库更新**：
```json
{
  "目标": {
    "<原始问题>": "我想了解LLM（大语言模型）",
    "<目标>": "系统性地学习大语言模型（LLM）的核心概念、关键技术、应用场景和实践方法，建立起完整的LLM知识体系"
  }
}
```

#### 步骤203：确认目标
- **内容**：询问用户是否认可设定好的目标
- **输出示例**：
```
(203)
基于您的原始问题，我为您设定了以下目标：

目标：系统性地学习大语言模型（LLM）的核心概念、关键技术、应用场景和实践方法，建立起完整的LLM知识体系

这是您的本意吗？
- 如果认可，请回复"认可"
- 如果不认可，请告诉我您希望调整的方向，我将重新设定目标
```

### 阶段三：300-399 分析维度

#### 步骤301：输出目标
- **内容**：再次输出最终确认的目标
- **输出示例**：
```
(301)
本次交流的目标：系统性地学习大语言模型（LLM）的核心概念、关键技术、应用场景和实践方法，建立起完整的LLM知识体系
```

#### 步骤302：分析维度
- **内容**：基于目标分析学习维度
- **LLM分析示例**：
```
分析逻辑：
首先理解LLM的基本概念和背景，然后深入到各个子领域，了解LLM的应用和实践，最后通过查看学习资源和进一步的学习路径，助您成为LLM领域的专家。

维度分析：
1. LLM基础知识：理解LLM的核心概念、发展历程和基本原理；
2. LLM子领域：深入了解LLM的各个重要子领域和技术方向；
3. LLM的应用和实践：了解LLM在实际场景中的应用案例和实践方法；
4. LLM学习资源和进一步学习：获取优质学习资源和规划进一步学习路径；
```

- **Python分析示例**：
```
分析逻辑：
从Python基础语法开始，逐步掌握核心概念和编程技巧，通过实际项目练习提升能力，最后学习常用库和框架，成为一名合格的Python开发者。

维度分析：
1. Python基础语法：掌握Python的基本语法、数据类型和控制结构；
2. Python核心概念：理解Python的面向对象、函数式编程等核心概念；
3. Python实际项目：通过实际项目练习提升编程能力；
4. Python常用库和框架：学习常用的Python库和开发框架；
```

- **数据库更新**：
```json
{
  "目标": {
    "<原始问题>": "我想了解LLM（大语言模型）",
    "<目标>": "系统性地学习大语言模型（LLM）的核心概念、关键技术、应用场景和实践方法，建立起完整的LLM知识体系",
    "<逻辑>": "首先理解LLM的基本概念和背景，然后深入到各个子领域..."
  },
  "维度分析": [
    {
      "<序号>": 1,
      "<维度名称>": "LLM基础知识",
      "<简要解释>": "理解LLM的核心概念、发展历程和基本原理",
      "<详细解释>": ""
    },
    {
      "<序号>": 2,
      "<维度名称>": "LLM子领域",
      "<简要解释>": "深入了解LLM的各个重要子领域和技术方向",
      "<详细解释>": ""
    }
  ]
}
```

#### 步骤303：确认维度
- **内容**：询问用户是否认可分析出的维度
- **输出示例**：
```
(303)
如果您认可我分析这个问题的逻辑和分析的维度，您可以告诉我"认可"
如果您不认可或者有其他的意见，您也可以增加、删除维度，或者修改分析逻辑，我会基于您的意见重新生成我的分析。
```

### 阶段四：400-499 细化解释和问答

#### 步骤401：输出目标
- **内容**：再次输出目标，确认上下文
- **输出示例**：
```
(401)
本次交流的目标：系统性地学习大语言模型（LLM）的核心概念、关键技术、应用场景和实践方法，建立起完整的LLM知识体系
```

#### 步骤402：输出维度详细解释
- **内容**：对每个维度提供详细的解释，使用生活类比
- **解释示例**（LLM基础知识）：
```
(402)
现在让我们深入了解第1个维度——LLM基础知识：

LLM基础知识就像学习一门新语言的基础语法一样。

首先，你需要了解什么是大语言模型。想象一下，如果你要学习英语，首先要认识26个字母、单词和基本语法。LLM的基础知识就是这样的"字母表"和"语法规则"。

大语言模型的核心原理是基于大量的文本数据训练出来的，就像一个孩子通过阅读大量书籍来学习语言一样。模型通过这些数据学会了理解语言的规律和上下文关系。

关键概念包括：
- 神经网络：就像人脑中的神经元网络，负责处理和传递信息
- Transformer架构：这是一种特殊的神经网络结构，就像语言的"骨架"，支撑起整个模型的能力
- 预训练和微调：就像先在学校学习基础知识，再在工作中学习专业技能

掌握这些基础知识，就像是盖房子前打好了地基，后续的学习都会更加稳固和高效。
```

#### 步骤403：询问是否有疑问
- **内容**：询问用户对当前维度是否有疑问
- **输出示例**：
```
您对这个维度是否存在什么疑问？如果有，请告诉我您的问题；如果没有，请回复'无'，我将继续下一个维度。
```

#### 步骤404：回答用户问题
- **内容**：基于用户问题提供针对性回答
- **问答示例**：
```
这是一个很好的问题！

简单来说，这个问题涉及到我们要学习的核心概念。

想象一下，如果你要了解"什么是汽车"，我会这样解释：
汽车是一种能够自动行驶的交通工具，它有四个轮子、一个发动机，可以载着人们从A地到B地。就像你骑的自行车是靠脚蹬，汽车是靠发动机驱动的，更省力、更快。

同样的，什么是LLM基础知识也是这个领域的一个重要概念，它是理解整个知识体系的基础。

简单来说，它就像是...（具体解释内容）

希望这个解释能帮助你理解！如果还有疑问，请随时提出。
```

- **数据库更新**：
```json
{
  "Q&A": [
    {
      "<序号>": 1,
      "<问题>": "什么是LLM基础知识？",
      "<回答>": "这是一个很好的问题！简单来说...",
      "<状态>": "未解决"
    }
  ]
}
```

#### 步骤405：确认问题是否解决
- **内容**：询问用户问题是否得到有效解决
- **输出示例**：
```
这个问题是否得到有效解决？
- 如果已解决，请回复'已解决'
- 如果解释不满意，请回复'重新解释'
- 如果产生了新问题，请直接提出新问题
```

#### 步骤406：继续下一个维度
- **内容**：如果用户没有疑问，继续下一个维度的解释
- **循环执行**：对每个维度重复步骤402-405

### 阶段五：500-599 支持的指令

#### 步骤500：输出指令帮助
- **内容**：输出所有支持的快捷指令
- **输出示例**：
```
(500)
所有的维度均已分析完毕，您可以通过以下指令来查看数据和生成图谱：

"/输出"：输出目标、维度分析、Q&A中的全部信息，并使用表格呈现
"/简介"：输出简介中的信息
"/目标"：输出目标中的信息
"/维度分析"：输出维度分析中的信息
"/Q&A"：输出Q&A中的信息
"/help"：查看帮助信息
"/知识图谱"：输出知识图谱，基于目标、维度分析、Q&A中的信息进行总结
```

#### 步骤501：处理用户指令
- **内容**：根据用户输入的指令执行相应操作
- **指令说明**：
  - `/输出`：输出全部信息（简介+目标+维度分析+Q&A）
  - `/简介`：输出应用简介
  - `/目标`：输出目标信息
  - `/维度分析`：输出维度分析（表格格式）
  - `/Q&A`：输出问答记录（表格格式）
  - `/help`：显示帮助信息
  - `/知识图谱`：生成并输出知识图谱

## 数据库结构

### 完整数据结构
```json
{
  "简介": {
    "<名字>": "SmartBot",
    "<功能简介>": "你是一款能够帮助使用者快速提升认知并帮助他建立起知识图谱的工具...",
    "<作者>": "Jackey&小七姐",
    "<帮助>": "你可以通过使用'/help'快捷指令，查看帮助操作"
  },
  "目标": {
    "<原始问题>": "",
    "<目标>": "",
    "<逻辑>": ""
  },
  "维度分析": [
    {
      "<序号>": 1,
      "<维度名称>": "",
      "<简要解释>": "",
      "<详细解释>": ""
    }
  ],
  "Q&A": [
    {
      "<序号>": 1,
      "<问题>": "",
      "<回答>": "",
      "<状态>": "未解决/已解决"
    }
  ]
}
```

## API接口说明

### 核心方法

#### process_knowledge_graph_workflow
```python
def process_knowledge_graph_workflow(self, user_input: str, workflow_step: int) -> Dict
```

**参数**：
- `user_input`: 用户输入的内容
- `workflow_step`: 当前工作流程步骤号

**返回**：
```json
{
  "output": "输出内容",
  "next_step": "下一步骤号",
  "action": "操作类型（continue/wait_for_input/wait_for_confirmation）"
}
```

**操作类型说明**：
- `continue`：直接进入下一步
- `wait_for_input`：等待用户输入
- `wait_for_confirmation`：等待用户确认

## 测试方法

### 自动化测试
运行完整流程的自动化测试：
```bash
cd /workspace/projects/data-analysis-iteration
python scripts/test_knowledge_graph.py
```

### 交互式测试
运行交互式测试，体验完整流程：
```python
# 修改 scripts/test_knowledge_graph.py
if __name__ == "__main__":
    # 注释掉自动化测试
    # test_knowledge_graph_application()
    
    # 启用交互式测试
    test_interactive_mode()
```

### 单独测试太史阁Agent
```python
from agents.taishige import TaishigeAgent

# 创建Agent
taishige = TaishigeAgent("TEST_001")

# 执行某个步骤
result = taishige.process_knowledge_graph_workflow("", 101)
print(result["output"])
```

## 前端对接

### 推荐实现方式

#### 方式一：完全对接（推荐）
前端实现完整的交互界面，后端太史阁Agent负责核心逻辑处理。

**前端组件**：
1. `KnowledgeGuideApp`：主应用组件
2. `ChatInterface`：对话界面，显示流程引导
3. `WorkflowProgress`：显示当前工作流程进度
4. `CommandPanel`：快捷指令面板
5. `KnowledgeGraphView`：知识图谱可视化

**API对接**：
```typescript
// 调用太史阁Agent的process_knowledge_graph_workflow方法
async function processWorkflow(userInput: string, step: number) {
  const response = await fetch('/api/taishige/workflow', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_input: userInput, workflow_step: step })
  });
  return response.json();
}
```

**状态管理**：
```typescript
interface WorkflowState {
  currentStep: number;
  knowledgeData: KnowledgeGraphData;
  chatHistory: Message[];
  userInput: string;
}

interface KnowledgeGraphData {
  intro: IntroData;
  goal: GoalData;
  dimensions: Dimension[];
  qa: QA[];
}
```

#### 方式二：简化对接
前端直接使用太史阁Agent的测试脚本，通过CLI交互。

**实现方式**：
- 前端提供终端界面
- 直接调用`scripts/test_knowledge_graph.py`
- 用户在终端中输入指令

## 扩展开发

### 添加新的维度分析规则

修改`_step_302_analyze_dimensions`方法，添加新的领域分析规则：

```python
def _step_302_analyze_dimensions(self) -> Dict:
    goal = self.knowledge_graph_db['目标']['<目标>']
    
    # 添加新的领域分析
    if "机器学习" in goal:
        logic = "..."
        dimensions = [
            {"<序号>": 1, "<维度名称>": "机器学习基础", "<简要解释>": "...", "<详细解释>": ""},
            # 更多维度...
        ]
    
    return logic, dimensions
```

### 优化详细解释生成

修改`_step_402_generate_detail`方法，提供更丰富的生活类比：

```python
def _step_402_generate_detail(self, dimension: Dict) -> str:
    name = dimension['<维度名称>']
    
    # 添加更多领域的详细解释
    if "机器学习基础" in name:
        return """机器学习基础就像教孩子学习一样。
        
想象一下，你教孩子认识苹果。你给他看苹果，告诉他"这是苹果"。
看多了，孩子就能自己认出苹果了。

机器学习也是这样。我们给模型看大量数据，告诉它正确的答案。
慢慢地，模型就能自己从数据中学习规律，做出预测。
..."""
    
    # 已有的LLM、Python等领域的解释
    # ...
```

### 集成NPU模型进行智能回答

修改`_step_404_answer_question`方法，调用NPU模型生成更智能的回答：

```python
from coze_workload_identity import requests

def _step_404_answer_question(self, question: str) -> str:
    """回答用户问题"""
    # 调用NPU模型生成回答
    skill_id = "7597819381221195791"
    api_key = os.getenv("COZE_GENIE_API_KEY_7597819381221195791")
    
    # 构建提示词
    prompt = f"""
    作为一个知识图谱引导助手，请用生活化的语言和类比来回答用户的问题。
    当前学习目标：{self.knowledge_graph_db['目标']['<目标>']}
    用户问题：{question}
    
    请提供：
    1. 简单易懂的解释
    2. 生活化类比
    3. 具体例子
    """
    
    # 调用GenieAPIService
    response = requests.post(
        "http://localhost:8000/generate",
        json={
            "model": "Qwen2.0-7B-SSD-8380-2.34",
            "prompt": prompt,
            "max_tokens": 500,
            "temperature": 0.7
        },
        headers={"Authorization": f"Bearer {api_key}"},
        timeout=30
    )
    
    result = response.json()
    return result["choices"][0]["text"]
```

### 添加知识图谱可视化

实现知识图谱的可视化展示：

```python
def generate_graph_data(self) -> Dict:
    """生成知识图谱数据"""
    goal = self.knowledge_graph_db["目标"]
    dimensions = self.knowledge_graph_db["维度分析"]
    
    # 生成节点
    nodes = [
        {
            "id": "goal",
            "label": goal["<目标>"],
            "type": "goal",
            "level": 0
        }
    ]
    
    # 生成维度节点
    for dim in dimensions:
        nodes.append({
            "id": f"dim_{dim['<序号>']}",
            "label": dim["<维度名称>"],
            "type": "dimension",
            "level": 1
        })
    
    # 生成边
    edges = []
    for dim in dimensions:
        edges.append({
            "source": "goal",
            "target": f"dim_{dim['<序号>']}",
            "label": "包含"
        })
    
    return {
        "nodes": nodes,
        "edges": edges
    }
```

## 注意事项

1. **数据持久化**：当前实现使用内存存储，生产环境建议使用SQLite或其他数据库持久化数据
2. **并发处理**：如果多个用户同时使用，需要考虑并发问题和数据隔离
3. **错误处理**：添加完善的错误处理机制，防止用户输入导致程序崩溃
4. **性能优化**：对于大型知识图谱，需要优化数据结构和算法，提升响应速度
5. **安全性**：如果集成NPU模型，需要添加适当的权限控制和数据加密
