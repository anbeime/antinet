#!/usr/bin/env python3
# backend/routes/chat_routes.py - çŸ¥è¯†åº“èŠå¤©è·¯ç”±
"""
æä¾›çŸ¥è¯†åº“æŸ¥è¯¢å’Œå¯¹è¯æœºå™¨äººåŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸ä¾èµ–å‘é‡æ£€ç´¢ï¼‰
"""
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any
import logging

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/chat", tags=["èŠå¤©æœºå™¨äºº"])


class ChatMessage(BaseModel):
    """èŠå¤©æ¶ˆæ¯"""
    role: str = Field(..., description="è§’è‰²: user|assistant|system")
    content: str = Field(..., description="æ¶ˆæ¯å†…å®¹")


class ChatRequest(BaseModel):
    """èŠå¤©è¯·æ±‚"""
    query: str = Field(..., description="ç”¨æˆ·æŸ¥è¯¢")
    conversation_history: List[ChatMessage] = Field(default_factory=list, description="å¯¹è¯å†å²")
    context: Dict[str, Any] = Field(default_factory=dict, description="ä¸Šä¸‹æ–‡ä¿¡æ¯")


class CardSource(BaseModel):
    """çŸ¥è¯†æ¥æº"""
    card_id: str
    card_type: str
    title: str
    similarity: float


class ChatResponse(BaseModel):
    """èŠå¤©å“åº”"""
    response: str
    sources: List[CardSource] = Field(default_factory=list)
    cards: List[Dict[str, Any]] = Field(default_factory=list)
    suggested_questions: List[str] = Field(default_factory=list, description="æ¨èçš„ç›¸å…³é—®é¢˜")


class CardSearchRequest(BaseModel):
    """å¡ç‰‡æœç´¢è¯·æ±‚"""
    query: str
    card_type: Optional[str] = None
    limit: int = 10


class CardSearchResponse(BaseModel):
    """å¡ç‰‡æœç´¢å“åº”"""
    cards: List[Dict[str, Any]] = Field(default_factory=list)
    total: int = 0


# é¢„è®¾çš„å››è‰²å¡ç‰‡çŸ¥è¯†åº“ï¼ˆåŸºäºé¡¹ç›®æ–‡æ¡£ï¼‰
PRESET_KNOWLEDGE_CARDS = {
    "blue": [  # äº‹å®å¡ç‰‡
        {
            "card_id": "fact_001",
            "card_type": "blue",
            "title": "Antinetç³»ç»Ÿæ¦‚è¿°",
            "content": {
                "description": "Antinetæ™ºèƒ½çŸ¥è¯†ç®¡å®¶æ˜¯ä¸€æ¬¾éƒ¨ç½²äºéªé¾™AIPCçš„ç«¯ä¾§æ™ºèƒ½æ•°æ®å·¥ä½œç«™ï¼Œé€šè¿‡é›†æˆNPUåŠ é€Ÿçš„è½»é‡åŒ–å¤§æ¨¡å‹ï¼Œå®ç°è‡ªç„¶è¯­è¨€é©±åŠ¨çš„æ•°æ®æŸ¥è¯¢ã€è‡ªåŠ¨æ•°æ®åˆ†æä¸å¯è§†åŒ–ã€å››è‰²å¡ç‰‡çŸ¥è¯†æ²‰æ·€ã€æ•°æ®ä¸å‡ºåŸŸã€NPUåŠ é€Ÿæ¨ç†ç­‰åŠŸèƒ½ã€‚"
            }
        },
        {
            "card_id": "fact_002",
            "card_type": "blue",
            "title": "æ ¸å¿ƒä»·å€¼",
            "content": {
                "description": "æ•ˆç‡æå‡70%ï¼ˆæ•°æ®åˆ†æä»æ•°å°æ—¶ç¼©çŸ­åˆ°åˆ†é’Ÿçº§ï¼‰ã€å®‰å…¨å¯æ§ï¼ˆç«¯ä¾§å¤„ç†ï¼Œä¼ä¸šæ•°æ®ä¸å‡ºåŸŸï¼‰ã€çŸ¥è¯†æ²‰æ·€ï¼ˆåˆ†æç»“æœå¯è¿½æº¯ã€å¯åä½œã€å¯å¤ç”¨ï¼‰ã€‚"
            }
        },
        {
            "card_id": "fact_003",
            "card_type": "blue",
            "title": "æŠ€æœ¯æ¶æ„",
            "content": {
                "description": "å‰ç«¯ä½¿ç”¨React 18 + TypeScript + Viteï¼Œåç«¯ä½¿ç”¨FastAPI 0.109 + Pythonï¼ŒAIæ¨ç†ä½¿ç”¨QAI AppBuilderï¼Œæ¨¡å‹ä¸ºQwen2-1.5Bï¼ˆINT8é‡åŒ–ï¼‰ï¼Œæ•°æ®åº“ä¸ºSQLite + DuckDBã€‚"
            }
        },
        {
            "card_id": "fact_004",
            "card_type": "blue",
            "title": "NPUæ€§èƒ½æŒ‡æ ‡",
            "content": {
                "description": "ä½¿ç”¨Qwen2.0-7B-SSDæ¨¡å‹ï¼Œæ¨ç†å»¶è¿Ÿçº¦450msï¼Œç›®æ ‡å»¶è¿Ÿ<500msï¼Œè¿è¡Œåœ¨éªé¾™Hexagon NPUï¼ˆHTPåç«¯ï¼‰ï¼ŒCPU vs NPUåŠ é€Ÿæ¯”4.2xã€‚"
            }
        },
        {
            "card_id": "fact_005",
            "card_type": "blue",
            "title": "å¼‚æ„è®¡ç®—æ¶æ„",
            "content": {
                "description": "NPUè´Ÿè´£æ ¸å¿ƒæ¨¡å‹æ¨ç†ï¼ˆ60-70%ç®—åŠ›å ç”¨ï¼‰ï¼ŒCPUè´Ÿè´£æ§åˆ¶é€»è¾‘å’Œæ•°æ®é¢„å¤„ç†ï¼ˆ20%ï¼‰ï¼ŒGPUè´Ÿè´£å›¾åƒå¤„ç†å’Œå¹¶è¡Œè®¡ç®—ï¼ˆ10%ï¼‰ã€‚"
            }
        },
        {
            "card_id": "fact_006",
            "card_type": "blue",
            "title": "8-Agentåä½œæ¶æ„",
            "content": {
                "description": "åŒ…æ‹¬é”¦è¡£å«æ€»æŒ‡æŒ¥ä½¿ï¼ˆä»»åŠ¡åˆ†è§£ä¸è°ƒåº¦ï¼‰ã€å¯†å·æˆ¿ï¼ˆæ•°æ®é¢„å¤„ç†ï¼‰ã€é€šæ”¿å¸ï¼ˆäº‹å®æå–ï¼‰ã€ç›‘å¯Ÿé™¢ï¼ˆè§£é‡Šç”Ÿæˆï¼‰ã€åˆ‘ç‹±å¸ï¼ˆé£é™©è¯†åˆ«ï¼‰ã€å‚è°‹å¸ï¼ˆè¡ŒåŠ¨å»ºè®®ï¼‰ã€å¤ªå²é˜ï¼ˆçŸ¥è¯†å­˜å‚¨ï¼‰ã€é©¿ä¼ å¸ï¼ˆç»“æœæ•´åˆï¼‰ã€‚"
            }
        },
        {
            "card_id": "fact_007",
            "card_type": "blue",
            "title": "å››è‰²å¡ç‰‡ç³»ç»Ÿ",
            "content": {
                "description": "è“è‰²å¡ç‰‡-æ ¸å¿ƒæ¦‚å¿µã€ç»¿è‰²å¡ç‰‡-å…³è”é“¾æ¥ã€é»„è‰²å¡ç‰‡-å‚è€ƒæ¥æºã€çº¢è‰²å¡ç‰‡-ç´¢å¼•å…³é”®è¯ã€‚åŸºäºå¢æ›¼å¡ç‰‡ç›’ç¬”è®°æ³•å®ç°çŸ¥è¯†ç®¡ç†ã€‚"
            }
        },
        {
            "card_id": "fact_008",
            "card_type": "blue",
            "title": "è®¿é—®åœ°å€",
            "content": {
                "description": "å‰ç«¯é¦–é¡µhttp://localhost:3000ã€NPUæ™ºèƒ½åˆ†æhttp://localhost:3000/npu-analysisã€åç«¯API http://localhost:8000ã€APIæ–‡æ¡£http://localhost:8000/docs"
            }
        },
        {
            "card_id": "fact_009",
            "card_type": "blue",
            "title": "ä¸€é”®å¯åŠ¨",
            "content": {
                "description": "è¿è¡Œstart_complete_system.batå¯ä¸€é”®å¯åŠ¨åç«¯ï¼ˆ8000ç«¯å£ï¼‰å’Œå‰ç«¯ï¼ˆ3001ç«¯å£ï¼‰æœåŠ¡ï¼ŒåŒ…æ‹¬å¥åº·æ£€æŸ¥ã€‚"
            }
        },
        {
            "card_id": "fact_010",
            "card_type": "blue",
            "title": "æ•°æ®æœ¬åœ°åŒ–",
            "content": {
                "description": "æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°SQLiteæ•°æ®åº“ä¸­ï¼Œæ•°æ®ä¸å‡ºåŸŸï¼Œä¼ä¸šæ•°æ®å®Œå…¨åœ¨æœ¬åœ°å¤„ç†ï¼Œä¿éšœéšç§å®‰å…¨ã€‚"
            }
        },
        {
            "card_id": "fact_011",
            "card_type": "blue",
            "title": "æ¯”èµ›ä¿¡æ¯",
            "content": {
                "description": "å‚åŠ 2025éªé¾™äººå·¥æ™ºèƒ½åˆ›æ–°åº”ç”¨å¤§èµ›ï¼ŒAIPCèµ›é“-é€šç”¨èµ›ï¼Œé¡¹ç›®åç§°ï¼šAntinetæ™ºèƒ½çŸ¥è¯†ç®¡å®¶ã€‚"
            }
        },
        {
            "card_id": "fact_012",
            "card_type": "blue",
            "title": "å›¢é˜Ÿæˆå‘˜ç®¡ç†",
            "content": {
                "description": "ç³»ç»Ÿæ”¯æŒæ·»åŠ å›¢é˜Ÿæˆå‘˜ã€åˆ†é…è§’è‰²ï¼ˆç®¡ç†å‘˜/ç¼–è¾‘/æŸ¥çœ‹è€…ï¼‰ã€è®¾ç½®æƒé™ï¼Œå¯ä»¥æŸ¥çœ‹æˆå‘˜åœ¨çº¿çŠ¶æ€å’Œè´¡çŒ®åº¦ã€‚"
            }
        }
    ],
    "green": [  # è§£é‡Šå¡ç‰‡
        {
            "card_id": "explain_001",
            "card_type": "green",
            "title": "ä¸ºä»€ä¹ˆä½¿ç”¨Antinet",
            "content": {
                "explanation": "AntinetåŸºäºå¢æ›¼å¡ç‰‡ç›’ç¬”è®°æ³•ï¼Œé‡‡ç”¨å››è‰²å¡ç‰‡ï¼ˆäº‹å®/è§£é‡Š/é£é™©/è¡ŒåŠ¨ï¼‰è¿›è¡ŒçŸ¥è¯†ç»„ç»‡ï¼Œå¸®åŠ©å›¢é˜Ÿæ›´å¥½åœ°ç®¡ç†å’Œåˆ†äº«çŸ¥è¯†ã€‚é€šè¿‡NPUåŠ é€Ÿå®ç°ç«¯ä¾§æ™ºèƒ½å¤„ç†ï¼Œä¿éšœæ•°æ®å®‰å…¨çš„åŒæ—¶æå‡æ•ˆç‡ã€‚"
            }
        },
        {
            "card_id": "explain_002",
            "card_type": "green",
            "title": "ä¸ºä»€ä¹ˆé€‰æ‹©NPU",
            "content": {
                "explanation": "NPUä¸“ç”¨ç¡¬ä»¶å¸¦æ¥æ€§èƒ½æå‡4.2xï¼ˆvs CPUï¼‰ã€åŠŸè€—é™ä½60%ã€å»¶è¿Ÿ<500mså®æ—¶å“åº”ã€‚ç›¸æ¯”CPUå’ŒGPUï¼ŒNPUåœ¨AIæ¨ç†ä»»åŠ¡ä¸Šæ›´åŠ é«˜æ•ˆèŠ‚èƒ½ã€‚"
            }
        },
        {
            "card_id": "explain_003",
            "card_type": "green",
            "title": "ä¸ºä»€ä¹ˆä½¿ç”¨ç«¯ä¾§AI",
            "content": {
                "explanation": "æ•°æ®éšç§ä¿æŠ¤ï¼ˆæ•°æ®ä¸å‡ºåŸŸï¼‰ã€å®æ—¶å“åº”èƒ½åŠ›ï¼ˆæ— éœ€ç½‘ç»œä¼ è¾“ï¼‰ã€ç¦»çº¿å¯ç”¨æ€§ï¼ˆä¸ä¾èµ–ç½‘ç»œè¿æ¥ï¼‰ã€æˆæœ¬ä¼˜åŠ¿ï¼ˆæ— éœ€äº‘ç«¯è®¡ç®—è´¹ç”¨ï¼‰ã€‚"
            }
        },
        {
            "card_id": "explain_004",
            "card_type": "green",
            "title": "8-Agentæ¶æ„ä¼˜åŠ¿",
            "content": {
                "explanation": "é€šè¿‡æ¨¡å—åŒ–æ™ºèƒ½å¤„ç†å®ç°ç²¾å‡†æ•°æ®åˆ†æï¼ŒåŒ…æ‹¬æ•°æ®æå–æ¨¡å—ï¼ˆè‡ªåŠ¨å¯¹æ¥æœ¬åœ°æ•°æ®æºï¼‰ã€åˆ†ææ¨ç†æ¨¡å—ï¼ˆåŸºäºNPUç”Ÿæˆå››è‰²å¡ç‰‡ï¼‰ã€å¯è§†åŒ–ç”Ÿæˆæ¨¡å—ï¼ˆè‡ªåŠ¨åŒ¹é…å›¾è¡¨ç±»å‹ï¼‰ã€è´¨é‡æ ¡éªŒæ¨¡å—ï¼ˆé€»è¾‘ä¸æ•°æ®åŒé‡æ ¡éªŒï¼‰ã€‚"
            }
        },
        {
            "card_id": "explain_005",
            "card_type": "green",
            "title": "å››è‰²å¡ç‰‡æ–¹æ³•è®º",
            "content": {
                "explanation": "è“è‰²å¡ç‰‡è®°å½•å®¢è§‚äº‹å®ï¼ˆå¦‚é”€é‡ã€å¢é•¿ç‡ï¼‰ï¼Œç»¿è‰²å¡ç‰‡è§£é‡ŠåŸå› ï¼ˆå¦‚æ•°æ®æ³¢åŠ¨èƒŒåçš„åŸå› ï¼‰ï¼Œé»„è‰²å¡ç‰‡è¯†åˆ«é£é™©ï¼ˆå¦‚åº“å­˜ä¸è¶³é¢„è­¦ï¼‰ï¼Œçº¢è‰²å¡ç‰‡æä¾›è¡ŒåŠ¨å»ºè®®ï¼ˆå¦‚è°ƒæ•´å®šä»·ã€è¡¥å……åº“å­˜ï¼‰ã€‚"
            }
        },
        {
            "card_id": "explain_006",
            "card_type": "green",
            "title": "æŠ€æœ¯é€‰å‹ç†ç”±",
            "content": {
                "explanation": "å‰ç«¯ä½¿ç”¨React/Viteè·å¾—å¿«é€Ÿå¼€å‘å’Œè‰¯å¥½ç”¨æˆ·ä½“éªŒï¼Œåç«¯ä½¿ç”¨FastAPIè·å¾—é«˜æ€§èƒ½å¼‚æ­¥APIï¼Œä½¿ç”¨SQLiteè·å¾—ç®€å•å¯é çš„æœ¬åœ°å­˜å‚¨ï¼Œä½¿ç”¨Qwen2æ¨¡å‹è·å¾—ç«¯ä¾§AIæ¨ç†èƒ½åŠ›ï¼Œä½¿ç”¨NPUå®ç°ç¡¬ä»¶åŠ é€Ÿã€‚"
            }
        },
        {
            "card_id": "explain_007",
            "card_type": "green",
            "title": "çŸ¥è¯†å›¾è°±ä¼˜åŠ¿",
            "content": {
                "explanation": "è·¨å¡ç‰‡è¯­ä¹‰åˆ†ææ„å»ºçŸ¥è¯†ç½‘ç»œï¼ˆå¦‚é”€å”®ä¸‹æ»‘å…³è”ç«å“é™ä»·ï¼‰ï¼Œå®ç°çŸ¥è¯†è‡ªåŠ¨å…³è”ä¸å›¾è°±æ„å»ºï¼Œæ”¯æŒæ£€ç´¢ä¼˜åŒ–ï¼ˆä¼˜å…ˆè¿”å›é«˜å…³è”åº¦å¡ç‰‡ï¼‰å’Œå½’æ¡£æ•´ç†ï¼ˆè‡ªåŠ¨æ ‡è®°æ— æ•ˆ/é‡å¤å¡ç‰‡ï¼‰ã€‚"
            }
        },
        {
            "card_id": "explain_008",
            "card_type": "green",
            "title": "æ¨¡å‹é‡åŒ–è¯´æ˜",
            "content": {
                "explanation": "Qwen2æ¨¡å‹ä½¿ç”¨INT8é‡åŒ–åœ¨éªé¾™NPUä¸Šè¿è¡Œï¼Œç›¸æ¯”FP16å‡å°‘50%å†…å­˜å ç”¨åŒæ—¶ä¿æŒè¾ƒé«˜ç²¾åº¦ã€‚é€šè¿‡QAI AppBuilderå°†æ¨¡å‹è½¬æ¢ä¸ºQNNæ ¼å¼ï¼Œå……åˆ†åˆ©ç”¨NPUç¡¬ä»¶ç‰¹æ€§ã€‚"
            }
        }
    ],
    "yellow": [  # é£é™©å¡ç‰‡
        {
            "card_id": "risk_001",
            "card_type": "yellow",
            "title": "æ•°æ®å¤‡ä»½é£é™©",
            "content": {
                "risk_level": "é«˜",
                "description": "å½“å‰ç‰ˆæœ¬æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°SQLiteæ•°æ®åº“ä¸­ï¼Œè¯·æ³¨æ„å®šæœŸå¤‡ä»½æ•°æ®åº“æ–‡ä»¶ï¼ˆbackend/data/knowledge.dbï¼‰ï¼Œå¦åˆ™å¯èƒ½é€ æˆæ•°æ®ä¸¢å¤±ã€‚"
            }
        },
        {
            "card_id": "risk_002",
            "card_type": "yellow",
            "title": "åç«¯APIä¾èµ–",
            "content": {
                "risk_level": "é«˜",
                "description": "å‰ç«¯åŠŸèƒ½å®Œå…¨ä¾èµ–äºåç«¯APIï¼Œå¦‚æœåç«¯æœåŠ¡æœªå¯åŠ¨ï¼ˆç«¯å£8000ï¼‰æˆ–NPUæœªæ­£ç¡®åŠ è½½ï¼Œå‰ç«¯å°†æ— æ³•æ­£å¸¸åŠ è½½æ•°æ®å’Œä½¿ç”¨AIåŠŸèƒ½ã€‚"
            }
        },
        {
            "card_id": "risk_003",
            "card_type": "yellow",
            "title": "NPUç¯å¢ƒä¾èµ–",
            "content": {
                "risk_level": "ä¸­",
                "description": "NPUåŠŸèƒ½éœ€è¦ARM64 Pythonç¯å¢ƒã€æ­£ç¡®çš„QAI AppBuilderç‰ˆæœ¬ï¼ˆ2.38.0ï¼‰ã€æ¨¡å‹æ–‡ä»¶è·¯å¾„é…ç½®ï¼ˆC:/model/Qwen2.0-7B-SSD-8380-2.34/ï¼‰å’ŒDLLè·¯å¾„é…ç½®ï¼Œé…ç½®é”™è¯¯ä¼šå¯¼è‡´NPUä¸å¯ç”¨ã€‚"
            }
        },
        {
            "card_id": "risk_004",
            "card_type": "yellow",
            "title": "æ€§èƒ½å»¶è¿Ÿä¸¥é‡è¶…æ ‡",
            "content": {
                "risk_level": "é«˜",
                "description": "å®æµ‹NPUæ¨ç†å»¶è¿Ÿ2840.5msï¼ˆ32 tokensï¼‰ï¼Œç›®æ ‡<500msï¼Œè¶…æ ‡5.6å€ï¼256 tokenså»¶è¿Ÿé«˜è¾¾3404.57msï¼Œè¿œè¶…å®æ—¶äº¤äº’è¦æ±‚ã€‚ä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒï¼Œéœ€è¦ç«‹å³ä¼˜åŒ–ã€‚"
            }
        },
        {
            "card_id": "risk_008",
            "card_type": "yellow",
            "title": "Qwen2.0-7Bæ¨¡å‹è¿‡å¤§",
            "content": {
                "risk_level": "é«˜",
                "description": "å½“å‰ä½¿ç”¨Qwen2.0-7B-SSDæ¨¡å‹ï¼ˆ7Bå‚æ•°ï¼‰ï¼Œå¯¹äºç«¯ä¾§å®æ—¶æ¨ç†è¿‡äºåºå¤§ã€‚256 tokensè¾“å…¥+32 tokensç”Ÿæˆéœ€è¦3404msï¼Œæ— æ³•æ»¡è¶³<500mså»¶è¿Ÿç›®æ ‡ã€‚"
            }
        },
        {
            "card_id": "risk_005",
            "card_type": "yellow",
            "title": "ç«¯å£å ç”¨é£é™©",
            "content": {
                "risk_level": "ä½",
                "description": "å¦‚æœ8000æˆ–3001ç«¯å£è¢«å…¶ä»–ç¨‹åºå ç”¨ï¼ŒæœåŠ¡å°†æ— æ³•å¯åŠ¨ã€‚ä½¿ç”¨netstat -ano | findstr :8000æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µã€‚"
            }
        },
        {
            "card_id": "risk_006",
            "card_type": "yellow",
            "title": "æ–‡ä»¶æ ¼å¼é™åˆ¶",
            "content": {
                "risk_level": "ä½",
                "description": "å½“å‰ä»…æ”¯æŒMarkdownå’Œæ–‡æœ¬æ–‡ä»¶å¯¼å…¥ï¼ŒPDF/Excel/Wordæ–‡ä»¶éœ€è¦åç«¯APIæ”¯æŒï¼ˆå¼€å‘ä¸­ï¼‰ã€‚å¯¼å…¥ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ä¼šå¯¼è‡´è§£æå¤±è´¥ã€‚"
            }
        },
        {
            "card_id": "risk_007",
            "card_type": "yellow",
            "title": "å›¢é˜Ÿåä½œé£é™©",
            "content": {
                "risk_level": "ä¸­",
                "description": "çŸ¥è¯†ç©ºé—´çš„æ•°æ®ç›®å‰å­˜å‚¨åœ¨æœ¬åœ°ï¼Œå›¢é˜Ÿæˆå‘˜ä¹‹é—´æ— æ³•ç›´æ¥å…±äº«æ•°æ®ã€‚éœ€è¦æ‰‹åŠ¨å¯¼å‡ºå¯¼å…¥æˆ–ä½¿ç”¨å¤–éƒ¨åŒæ­¥å·¥å…·ã€‚"
            }
        }
    ],
    "red": [  # è¡ŒåŠ¨å¡ç‰‡
        {
            "card_id": "action_001",
            "card_type": "red",
            "title": "å¯åŠ¨åç«¯æœåŠ¡",
            "content": {
                "priority": "é«˜",
                "action": "æ–¹æ³•1ï¼šè¿è¡Œstart_complete_system.batä¸€é”®å¯åŠ¨ã€‚æ–¹æ³•2ï¼šcd backend && python main.pyå¯åŠ¨åç«¯æœåŠ¡ï¼Œé»˜è®¤è¿è¡Œåœ¨8000ç«¯å£ã€‚å¯åŠ¨åè®¿é—®http://localhost:8000/api/healthéªŒè¯æœåŠ¡çŠ¶æ€ã€‚"
            }
        },
        {
            "card_id": "action_002",
            "card_type": "red",
            "title": "å¯åŠ¨å‰ç«¯æœåŠ¡",
            "content": {
                "priority": "é«˜",
                "action": "æ–¹æ³•1ï¼šè¿è¡Œstart_complete_system.batä¸€é”®å¯åŠ¨ã€‚æ–¹æ³•2ï¼šåœ¨data-analysis-iteration/frontendç›®å½•è¿è¡Œnpm run devï¼Œé»˜è®¤è¿è¡Œåœ¨3001ç«¯å£ã€‚è®¿é—®http://localhost:3001æŸ¥çœ‹å‰ç«¯ç•Œé¢ã€‚"
            }
        },
        {
            "card_id": "action_003",
            "card_type": "red",
            "title": "éªŒè¯NPUç¯å¢ƒ",
            "content": {
                "priority": "ä¸­",
                "action": "è¿è¡Œverify-npu-on-aipc.ps1è„šæœ¬è‡ªåŠ¨æ£€æŸ¥Pythonç‰ˆæœ¬ã€QAI AppBuilderå®‰è£…ã€æ¨¡å‹æ–‡ä»¶å­˜åœ¨æ€§ã€QNNåº“æ–‡ä»¶å®Œæ•´æ€§å’ŒNPUæ€§èƒ½æµ‹è¯•ã€‚æˆ–è¿è¡Œpython simple_npu_test_v2.pyæ‰‹åŠ¨æµ‹è¯•ã€‚"
            }
        },
        {
            "card_id": "action_004",
            "card_type": "red",
            "title": "ç´§æ€¥ä¼˜åŒ–å»¶è¿Ÿï¼ˆä»2840msåˆ°<500msï¼‰",
            "content": {
                "priority": "é«˜",
                "action": "æ–¹æ¡ˆ1ï¼ˆæ¨èï¼‰ï¼šåˆ‡æ¢åˆ°æ›´å°æ¨¡å‹ï¼Œå¦‚Qwen2-1.5Bæˆ–Llama3.2-3Bï¼Œé¢„æœŸå»¶è¿Ÿ280-400msã€‚æ–¹æ¡ˆ2ï¼šå¯ç”¨BURSTæ€§èƒ½æ¨¡å¼ï¼šfrom qai_hub_models.models._shared.perf_profile import PerfProfile; PerfProfile.SetPerfProfileGlobal(PerfProfile.BURST)ã€‚æ–¹æ¡ˆ3ï¼šå‡å°‘max_tokensåˆ°16-32ã€‚æ–¹æ¡ˆ4ï¼šä½¿ç”¨INT4è¿›ä¸€æ­¥é‡åŒ–ã€‚æ–¹æ¡ˆ5ï¼šæ··åˆæ¨ç†ï¼ˆå°æ¨¡å‹+å¤§æ¨¡å‹ï¼‰ã€‚"
            }
        },
        {
            "card_id": "action_011",
            "card_type": "red",
            "title": "éªŒè¯NPUæ€§èƒ½æ¨¡å¼",
            "content": {
                "priority": "é«˜",
                "action": "æ£€æŸ¥backend/npu_core.pyæˆ–backend/models/model_loader.pyï¼Œç¡®è®¤æ˜¯å¦è®¾ç½®äº†BURSTæ¨¡å¼ã€‚æ·»åŠ PerfProfile.SetPerfProfileGlobal(PerfProfile.BURST)åœ¨æ¨¡å‹åŠ è½½åã€‚é‡æ–°è¿è¡ŒåŸºå‡†æµ‹è¯•ï¼Œé¢„æœŸå»¶è¿Ÿåº”é™ä½30-50%ã€‚"
            }
        },
        {
            "card_id": "action_012",
            "card_type": "red",
            "title": "åˆ‡æ¢åˆ°è½»é‡æ¨¡å‹",
            "content": {
                "priority": "é«˜",
                "action": "ä¸‹è½½Qwen2-1.5B-Instructæˆ–Llama3.2-3Bæ¨¡å‹ï¼Œé…ç½®åˆ°MODEL_PATHã€‚ä¿®æ”¹backend/config.pyä¸­çš„MODEL_NAMEå’ŒMODEL_PATHã€‚é‡å¯åç«¯æœåŠ¡ï¼Œé‡æ–°è¿è¡ŒåŸºå‡†æµ‹è¯•éªŒè¯å»¶è¿Ÿ<500msã€‚"
            }
        },
        {
            "card_id": "action_005",
            "card_type": "red",
            "title": "å¤‡ä»½æ•°æ®",
            "content": {
                "priority": "é«˜",
                "action": "å®šæœŸå¤‡ä»½backend/data/knowledge.dbæ•°æ®åº“æ–‡ä»¶ã€‚å¯ä»¥æ‰‹åŠ¨å¤åˆ¶åˆ°å®‰å…¨ä½ç½®ï¼Œæˆ–è®¾ç½®è‡ªåŠ¨å¤‡ä»½è„šæœ¬ã€‚å¤‡ä»½å‰åœæ­¢åç«¯æœåŠ¡ä»¥é˜²æ•°æ®æŸåã€‚"
            }
        },
        {
            "card_id": "action_006",
            "card_type": "red",
            "title": "æ£€æŸ¥APIæ–‡æ¡£",
            "content": {
                "priority": "ä½",
                "action": "è®¿é—®http://localhost:8000/docsæŸ¥çœ‹å®Œæ•´çš„Swagger APIæ–‡æ¡£ï¼Œäº†è§£æ‰€æœ‰å¯ç”¨çš„APIç«¯ç‚¹å’Œå‚æ•°ã€‚åœ¨å¼€å‘æ–°åŠŸèƒ½å‰å…ˆé˜…è¯»APIæ–‡æ¡£ç¡®ä¿æ­£ç¡®ä½¿ç”¨ã€‚"
            }
        },
        {
            "card_id": "action_007",
            "card_type": "red",
            "title": "å¯¼å…¥çŸ¥è¯†å¡ç‰‡",
            "content": {
                "priority": "ä¸­",
                "action": "åœ¨å‰ç«¯ç‚¹å‡»å¯¼å…¥æŒ‰é’®ï¼Œé€‰æ‹©Markdownæˆ–æ–‡æœ¬æ–‡ä»¶å¯¼å…¥ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è§£ææ–‡ä»¶å†…å®¹å¹¶ç”ŸæˆçŸ¥è¯†å¡ç‰‡ã€‚å¯¼å…¥å‰ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼Œå†…å®¹æ¸…æ™°ã€‚"
            }
        },
        {
            "card_id": "action_008",
            "card_type": "red",
            "title": "ä½¿ç”¨èŠå¤©æœºå™¨äºº",
            "content": {
                "priority": "ä½",
                "action": "ç‚¹å‡»å³ä¸‹è§’æœºå™¨äººå›¾æ ‡æ‰“å¼€èŠå¤©çª—å£ï¼Œè¾“å…¥é—®é¢˜å¦‚'å¦‚ä½•å¯åŠ¨ç³»ç»Ÿ'ã€'NPUæ€§èƒ½å¦‚ä½•'ç­‰ï¼Œç³»ç»Ÿä¼šåŸºäºçŸ¥è¯†åº“å››è‰²å¡ç‰‡å›ç­”æ‚¨çš„é—®é¢˜ã€‚"
            }
        },
        {
            "card_id": "action_009",
            "card_type": "red",
            "title": "æŸ¥çœ‹åˆ†ææŠ¥å‘Š",
            "content": {
                "priority": "ä¸­",
                "action": "åœ¨å‰ç«¯NPUåˆ†æé¡µé¢è¾“å…¥è‡ªç„¶è¯­è¨€æŸ¥è¯¢å¦‚'åˆ†æä¸Šä¸ªæœˆçš„é”€å”®è¶‹åŠ¿'ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æå–æ•°æ®ã€ç”Ÿæˆå››è‰²å¡ç‰‡åˆ†æã€åˆ›å»ºå¯è§†åŒ–å›¾è¡¨å¹¶ç”Ÿæˆå®Œæ•´æŠ¥å‘Šã€‚"
            }
        },
        {
            "card_id": "action_010",
            "card_type": "red",
            "title": "å›¢é˜Ÿåä½œè®¾ç½®",
            "content": {
                "priority": "ä¸­",
                "action": "åœ¨å›¢é˜Ÿæˆå‘˜ç®¡ç†é¡µé¢æ·»åŠ æˆå‘˜ã€åˆ†é…è§’è‰²ï¼ˆç®¡ç†å‘˜/ç¼–è¾‘/æŸ¥çœ‹è€…ï¼‰ã€è®¾ç½®ç©ºé—´æƒé™ã€‚ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹æˆå‘˜åœ¨çº¿çŠ¶æ€å’Œè´¡çŒ®åº¦ï¼Œç›‘æ§å›¢é˜Ÿæ´»åŠ¨ã€‚"
            }
        }
    ]
}


def _search_cards_by_keyword(query: str, limit: int = 10) -> List[Dict[str, Any]]:
    """
    ä½¿ç”¨å…³é”®è¯æœç´¢é¢„è®¾çš„çŸ¥è¯†å¡ç‰‡

    å‚æ•°ï¼š
        query: æŸ¥è¯¢å…³é”®è¯
        limit: è¿”å›æ•°é‡é™åˆ¶

    è¿”å›ï¼š
        åŒ¹é…çš„å¡ç‰‡åˆ—è¡¨
    """
    all_cards = []
    query_lower = query.lower()

    for card_type, cards in PRESET_KNOWLEDGE_CARDS.items():
        for card in cards:
            # åœ¨æ ‡é¢˜å’Œå†…å®¹ä¸­æœç´¢å…³é”®è¯
            title_lower = card['title'].lower()
            content = card.get('content', {})
            content_str = ' '.join(str(v) for v in content.values()).lower()

            if query_lower in title_lower or query_lower in content_str:
                card['similarity'] = 0.8  # ç®€å•ç›¸ä¼¼åº¦è¯„åˆ†
                all_cards.append(card)

    # æŒ‰ç›¸ä¼¼åº¦æ’åºå¹¶é™åˆ¶æ•°é‡
    all_cards.sort(key=lambda x: x['similarity'], reverse=True)
    return all_cards[:limit]


def _generate_response(query: str, relevant_cards: List[Dict]) -> str:
    """
    ç”Ÿæˆå›å¤ï¼ˆåŸºäºæ£€ç´¢åˆ°çš„å¡ç‰‡ï¼‰

    å‚æ•°ï¼š
        query: ç”¨æˆ·æŸ¥è¯¢
        relevant_cards: ç›¸å…³å¡ç‰‡

    è¿”å›ï¼š
        å›å¤å†…å®¹
    """
    try:
        if not relevant_cards:
            return "æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰æ‰¾åˆ°ä¸æ‚¨çš„é—®é¢˜ç›¸å…³çš„çŸ¥è¯†å¡ç‰‡ã€‚æ‚¨å¯ä»¥å°è¯•æ¢ä¸ªé—®æ³•ï¼Œæˆ–è€…è”ç³»ç®¡ç†å‘˜æ·»åŠ ç›¸å…³çŸ¥è¯†ã€‚\n\næˆ‘å¯ä»¥å¸®åŠ©æ‚¨è§£ç­”å…³äºAntinetç³»ç»ŸåŠŸèƒ½ã€å›¢é˜Ÿåä½œã€çŸ¥è¯†ç®¡ç†ç­‰æ–¹é¢çš„é—®é¢˜ã€‚"

        # æ ¹æ®å¡ç‰‡ç±»å‹æ„å»ºå›å¤
        blue_cards = [c for c in relevant_cards if c.get("card_type") == "blue"]
        green_cards = [c for c in relevant_cards if c.get("card_type") == "green"]
        yellow_cards = [c for c in relevant_cards if c.get("card_type") == "yellow"]
        red_cards = [c for c in relevant_cards if c.get("card_type") == "red"]

        response_parts = []

        # è“è‰²å¡ç‰‡ï¼šäº‹å®
        if blue_cards:
            response_parts.append("ğŸ“Š **ç›¸å…³äº‹å®ï¼š**\n")
            for card in blue_cards[:3]:
                title = card.get("title", "æ— æ ‡é¢˜")
                content = card.get("content", {})
                desc = content.get("description", "æ— æè¿°") if isinstance(content, dict) else "æ— æè¿°"
                response_parts.append(f"- {title}\n  {desc}\n")

        # ç»¿è‰²å¡ç‰‡ï¼šè§£é‡Š
        if green_cards:
            response_parts.append("\n **åŸå› è§£é‡Šï¼š**\n")
            for card in green_cards[:2]:
                title = card.get("title", "æ— æ ‡é¢˜")
                content = card.get("content", {})
                explanation = content.get("explanation", "æ— è§£é‡Š") if isinstance(content, dict) else "æ— è§£é‡Š"
                response_parts.append(f"- {title}\n  {explanation}\n")

        # é»„è‰²å¡ç‰‡ï¼šé£é™©
        if yellow_cards:
            response_parts.append("\n **ç›¸å…³é£é™©ï¼š**\n")
            for card in yellow_cards[:2]:
                title = card.get("title", "æ— æ ‡é¢˜")
                content = card.get("content", {})
                level = content.get("risk_level", "æœªçŸ¥") if isinstance(content, dict) else "æœªçŸ¥"
                desc = content.get("description", "æ— æè¿°") if isinstance(content, dict) else "æ— æè¿°"
                response_parts.append(f"- {title} (ç­‰çº§: {level})\n  {desc}\n")

        # çº¢è‰²å¡ç‰‡ï¼šè¡ŒåŠ¨å»ºè®®
        if red_cards:
            response_parts.append("\nğŸ¯ **è¡ŒåŠ¨å»ºè®®ï¼š**\n")
            for card in red_cards[:2]:
                title = card.get("title", "æ— æ ‡é¢˜")
                content = card.get("content", {})
                priority = content.get("priority", "æœªçŸ¥") if isinstance(content, dict) else "æœªçŸ¥"
                action = content.get("action", "æ— è¡ŒåŠ¨") if isinstance(content, dict) else "æ— è¡ŒåŠ¨"
                response_parts.append(f"- {title} (ä¼˜å…ˆçº§: {priority})\n  {action}\n")

        # æ€»ç»“
        response_parts.append(f"\n **æ¥æºè¯´æ˜ï¼š**\nåŸºäºçŸ¥è¯†åº“ä¸­æ‰¾åˆ°çš„ {len(relevant_cards)} å¼ ç›¸å…³å¡ç‰‡ç”Ÿæˆã€‚")

        return "\n".join(response_parts)

    except Exception as e:
        logger.error(f"ç”Ÿæˆå›å¤å¤±è´¥: {e}", exc_info=True)
        return "æŠ±æ­‰ï¼Œç”Ÿæˆå›å¤æ—¶å‡ºç°äº†é”™è¯¯ã€‚"


def _generate_suggested_questions(query: str, relevant_cards: List[Dict]) -> List[str]:
    """
    æ ¹æ®æŸ¥è¯¢å’Œç›¸å…³å¡ç‰‡ç”Ÿæˆæ¨èé—®é¢˜
    
    å‚æ•°:
        query: ç”¨æˆ·æŸ¥è¯¢
        relevant_cards: ç›¸å…³å¡ç‰‡
        
    è¿”å›:
        æ¨èé—®é¢˜åˆ—è¡¨ï¼ˆæœ€å¤š3ä¸ªï¼‰
    """
    suggestions = []
    
    # åŸºäºæŸ¥è¯¢å…³é”®è¯çš„æ¨èé—®é¢˜æ˜ å°„
    keyword_questions = {
        "ç³»ç»Ÿ": [
            "Antinetç³»ç»Ÿæœ‰å“ªäº›æ ¸å¿ƒåŠŸèƒ½ï¼Ÿ",
            "å¦‚ä½•å¯åŠ¨Antinetç³»ç»Ÿï¼Ÿ",
            "ç³»ç»Ÿçš„æŠ€æœ¯æ¶æ„æ˜¯æ€æ ·çš„ï¼Ÿ"
        ],
        "NPU": [
            "NPUæ¨ç†æ€§èƒ½å¦‚ä½•ä¼˜åŒ–ï¼Ÿ",
            "å¦‚ä½•éªŒè¯NPUæ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ",
            "NPUå’ŒCPUçš„æ€§èƒ½å·®å¼‚æœ‰å¤šå¤§ï¼Ÿ"
        ],
        "å¡ç‰‡": [
            "å››è‰²å¡ç‰‡åˆ†åˆ«ä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Ÿ",
            "å¦‚ä½•åˆ›å»ºå’Œç®¡ç†çŸ¥è¯†å¡ç‰‡ï¼Ÿ",
            "å¡ç‰‡ç³»ç»Ÿçš„è®¾è®¡ç†å¿µæ˜¯ä»€ä¹ˆï¼Ÿ"
        ],
        "å›¢é˜Ÿ": [
            "å¦‚ä½•è¿›è¡Œå›¢é˜Ÿåä½œï¼Ÿ",
            "å›¢é˜Ÿæˆå‘˜å¦‚ä½•å…±äº«çŸ¥è¯†ï¼Ÿ",
            "åä½œæ´»åŠ¨å¦‚ä½•è®°å½•å’ŒæŸ¥çœ‹ï¼Ÿ"
        ],
        "æ•°æ®": [
            "æ•°æ®å¦‚ä½•ä¿è¯å®‰å…¨æ€§ï¼Ÿ",
            "æ”¯æŒå“ªäº›æ•°æ®æ ¼å¼ï¼Ÿ",
            "å¦‚ä½•è¿›è¡Œæ•°æ®åˆ†æï¼Ÿ"
        ],
        "å¯åŠ¨": [
            "å¦‚ä½•ä¸€é”®å¯åŠ¨ç³»ç»Ÿï¼Ÿ",
            "å¯åŠ¨å¤±è´¥å¦‚ä½•æ’æŸ¥ï¼Ÿ",
            "éœ€è¦å“ªäº›ç¯å¢ƒä¾èµ–ï¼Ÿ"
        ],
        "æ€§èƒ½": [
            "å¦‚ä½•ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ï¼Ÿ",
            "æ¨ç†å»¶è¿Ÿå¤šå°‘ç®—æ­£å¸¸ï¼Ÿ",
            "æ€§èƒ½ç“¶é¢ˆåœ¨å“ªé‡Œï¼Ÿ"
        ],
        "API": [
            "ç³»ç»Ÿæä¾›å“ªäº›APIæ¥å£ï¼Ÿ",
            "å¦‚ä½•è°ƒç”¨APIè¿›è¡Œå¼€å‘ï¼Ÿ",
            "APIæ–‡æ¡£åœ¨å“ªé‡ŒæŸ¥çœ‹ï¼Ÿ"
        ]
    }
    
    # åŸºäºå¡ç‰‡ç±»å‹çš„æ¨èé—®é¢˜
    card_type_questions = {
        "blue": [
            "è¿˜æœ‰å“ªäº›ç›¸å…³çš„äº‹å®ä¿¡æ¯ï¼Ÿ",
            "è¿™ä¸ªåŠŸèƒ½çš„å…·ä½“å‚æ•°æ˜¯ä»€ä¹ˆï¼Ÿ",
            "æœ‰æ²¡æœ‰æ›´è¯¦ç»†çš„è¯´æ˜æ–‡æ¡£ï¼Ÿ"
        ],
        "green": [
            "ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ",
            "æœ‰æ²¡æœ‰å…¶ä»–å®ç°æ–¹å¼ï¼Ÿ",
            "è¿™ç§æ–¹æ³•çš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"
        ],
        "yellow": [
            "å¦‚ä½•é¿å…è¿™äº›é£é™©ï¼Ÿ",
            "é‡åˆ°é—®é¢˜å¦‚ä½•æ’æŸ¥ï¼Ÿ",
            "æœ‰å“ªäº›æ³¨æ„äº‹é¡¹ï¼Ÿ"
        ],
        "red": [
            "å…·ä½“æ“ä½œæ­¥éª¤æ˜¯ä»€ä¹ˆï¼Ÿ",
            "æœ‰æ²¡æœ‰å¿«æ·æ–¹å¼ï¼Ÿ",
            "å®Œæˆåå¦‚ä½•éªŒè¯ï¼Ÿ"
        ]
    }
    
    # 1. æ ¹æ®æŸ¥è¯¢å…³é”®è¯æ¨è
    query_lower = query.lower()
    for keyword, questions in keyword_questions.items():
        if keyword in query_lower or keyword in query:
            suggestions.extend(questions)
            break
    
    # 2. æ ¹æ®ç›¸å…³å¡ç‰‡ç±»å‹æ¨è
    if relevant_cards:
        card_types = [c.get("card_type") for c in relevant_cards[:3]]
        most_common_type = max(set(card_types), key=card_types.count) if card_types else None
        if most_common_type and most_common_type in card_type_questions:
            suggestions.extend(card_type_questions[most_common_type])
    
    # 3. é€šç”¨æ¨èé—®é¢˜ï¼ˆå…œåº•ï¼‰
    if not suggestions:
        suggestions = [
            "Antinetç³»ç»Ÿæœ‰å“ªäº›æ ¸å¿ƒåŠŸèƒ½ï¼Ÿ",
            "å¦‚ä½•å¿«é€Ÿä¸Šæ‰‹ä½¿ç”¨ç³»ç»Ÿï¼Ÿ",
            "ç³»ç»Ÿæ”¯æŒå“ªäº›æ•°æ®åˆ†æåŠŸèƒ½ï¼Ÿ"
        ]
    
    # å»é‡å¹¶è¿”å›å‰3ä¸ª
    unique_suggestions = []
    for q in suggestions:
        if q not in unique_suggestions:
            unique_suggestions.append(q)
        if len(unique_suggestions) >= 3:
            break
    
    return unique_suggestions


@router.post("/query", response_model=ChatResponse)
async def chat_query(request: ChatRequest):
    """
    çŸ¥è¯†åº“æŸ¥è¯¢æ¥å£

    æ¥æ”¶ç”¨æˆ·æŸ¥è¯¢ï¼Œè¿”å›åŸºäºçŸ¥è¯†åº“çš„å›å¤
    """
    logger.info(f"[ChatRoutes] æ”¶åˆ°æŸ¥è¯¢: {request.query}")

    try:
        # ä½¿ç”¨å…³é”®è¯æœç´¢é¢„è®¾çš„çŸ¥è¯†å¡ç‰‡
        cards = _search_cards_by_keyword(request.query, limit=10)

        # ç”Ÿæˆå›å¤
        response = _generate_response(request.query, cards)
        
        # ç”Ÿæˆæ¨èé—®é¢˜
        suggested_questions = _generate_suggested_questions(request.query, cards)

        # æ„å»ºå“åº”
        result = ChatResponse(
            response=response,
            sources=[
                CardSource(
                    card_id=card["card_id"],
                    card_type=card["card_type"],
                    title=card["title"],
                    similarity=card.get("similarity", 0.8)
                )
                for card in cards[:5]
            ],
            cards=cards[:10],
            suggested_questions=suggested_questions
        )

        logger.info(f"[ChatRoutes] æŸ¥è¯¢å®Œæˆ: {len(cards)}æ¡ç›¸å…³å¡ç‰‡, {len(suggested_questions)}ä¸ªæ¨èé—®é¢˜")
        return result

    except Exception as e:
        logger.error(f"[ChatRoutes] æŸ¥è¯¢å¤±è´¥: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.post("/search", response_model=CardSearchResponse)
async def search_cards(request: CardSearchRequest):
    """
    å¡ç‰‡æœç´¢æ¥å£

    æœç´¢çŸ¥è¯†åº“ä¸­çš„å¡ç‰‡
    """
    logger.info(f"[ChatRoutes] æœç´¢å¡ç‰‡: {request.query} (ç±»å‹: {request.card_type})")

    try:
        # ä½¿ç”¨å…³é”®è¯æœç´¢
        cards = _search_cards_by_keyword(request.query, limit=request.limit)

        # å¦‚æœæŒ‡å®šäº†å¡ç‰‡ç±»å‹ï¼Œè¿›è¡Œè¿‡æ»¤
        if request.card_type:
            cards = [c for c in cards if c.get("card_type") == request.card_type]

        result = CardSearchResponse(
            cards=cards,
            total=len(cards)
        )

        logger.info(f"[ChatRoutes] æœç´¢å®Œæˆ: {len(cards)}æ¡ç»“æœ")
        return result

    except Exception as e:
        logger.error(f"[ChatRoutes] æœç´¢å¤±è´¥: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/cards")
async def list_cards(
    card_type: Optional[str] = None,
    limit: int = 50,
    offset: int = 0
):
    """
    åˆ—å‡ºçŸ¥è¯†å¡ç‰‡

    å‚æ•°ï¼š
        card_type: å¡ç‰‡ç±»å‹è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
        limit: è¿”å›æ•°é‡é™åˆ¶ï¼ˆé»˜è®¤50ï¼‰
        offset: åç§»é‡ï¼ˆé»˜è®¤0ï¼‰
    """
    logger.info(f"[ChatRoutes] åˆ—å‡ºå¡ç‰‡ (ç±»å‹: {card_type}, é™åˆ¶: {limit})")

    try:
        # è·å–æ‰€æœ‰å¡ç‰‡
        all_cards = []
        for cards in PRESET_KNOWLEDGE_CARDS.values():
            all_cards.extend(cards)

        # å¦‚æœæŒ‡å®šäº†å¡ç‰‡ç±»å‹ï¼Œè¿›è¡Œè¿‡æ»¤
        if card_type:
            all_cards = [c for c in all_cards if c.get("card_type") == card_type]

        # åº”ç”¨åç§»å’Œé™åˆ¶
        total = len(all_cards)
        cards = all_cards[offset:offset + limit]

        return {
            "cards": cards,
            "total": total
        }

    except Exception as e:
        logger.error(f"[ChatRoutes] åˆ—å‡ºå¡ç‰‡å¤±è´¥: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/card/{card_id}")
async def get_card(card_id: str):
    """
    è·å–å•ä¸ªå¡ç‰‡è¯¦æƒ…

    å‚æ•°ï¼š
        card_id: å¡ç‰‡ID

    è¿”å›ï¼š
        å¡ç‰‡è¯¦æƒ…
    """
    logger.info(f"[ChatRoutes] è·å–å¡ç‰‡: {card_id}")

    try:
        # åœ¨é¢„è®¾å¡ç‰‡ä¸­æŸ¥æ‰¾
        for cards in PRESET_KNOWLEDGE_CARDS.values():
            for card in cards:
                if card.get("card_id") == card_id:
                    return card

        raise HTTPException(
            status_code=404,
            detail=f"å¡ç‰‡ä¸å­˜åœ¨: {card_id}"
        )

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"[ChatRoutes] è·å–å¡ç‰‡å¤±è´¥: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/health")
async def health_check():
    """
    èŠå¤©æœºå™¨äººå¥åº·æ£€æŸ¥

    è¿”å›ï¼š
        æœåŠ¡çŠ¶æ€
    """
    try:
        # ç®€åŒ–ç‰ˆæœ¬ï¼Œæ€»æ˜¯è¿”å›å¥åº·çŠ¶æ€
        return {
            "status": "healthy",
            "database_initialized": True,
            "search_type": "keyword_match"  # ä½¿ç”¨å…³é”®è¯åŒ¹é…è€Œéå‘é‡æ£€ç´¢
        }
    except Exception as e:
        logger.error(f"[ChatRoutes] å¥åº·æ£€æŸ¥å¤±è´¥: {e}", exc_info=True)
        return {
            "status": "degraded",
            "database_initialized": False,
            "error": str(e)
        }
