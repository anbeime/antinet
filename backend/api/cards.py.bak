"""
卡片API路由
"""
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import List, Optional
import logging
import time

logger = logging.getLogger(__name__)
router = APIRouter()


class Card(BaseModel):
    """卡片模型"""
    id: str
    type: str  # blue/green/yellow/red
    title: str
    content: dict
    confidence: float
    timestamp: str
    tags: List[str] = []
    references: List[str] = []


class CardListResponse(BaseModel):
    """卡片列表响应"""
    cards: List[Card]
    total: int


@router.get("", response_model=CardListResponse)
async def get_cards(
    card_type: Optional[str] = None,
    limit: int = 50,
    offset: int = 0
):
    """
    获取卡片列表

    从太史阁（Taishige）知识库获取真实的卡片数据

    参数：
        card_type: 卡片类型（blue/green/yellow/red）
        limit: 返回数量限制
        offset: 偏移量

    返回：
        卡片列表和总数
    """
    try:
        # 从太史阁获取卡片
        from agents.taishige import TaishigeAgent

        taishi_ge = TaishigeAgent(task_id="cards_api")
        cards_raw, total = taishi_ge.get_cards(card_type=card_type, limit=limit, offset=offset)

        # 转换为Card模型
        cards = []
        for card_data in cards_raw:
            cards.append(Card(
                id=card_data['id'],
                type=card_data['type'],
                title=card_data['title'],
                content=card_data['content'],
                confidence=card_data.get('confidence', 0.8),
                timestamp=card_data.get('timestamp', time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime())),
                tags=card_data.get('tags', []),
                references=card_data.get('references', [])
            ))

        return CardListResponse(cards=cards, total=total)

    except Exception as e:
        logger.error(f"获取卡片列表失败: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.post("")
async def create_card(card: Card):
    """
    创建新卡片

    存储到太史阁（Taishige）知识库

    参数：
        card: 卡片数据（JSON格式）

    返回：
        创建的卡片ID
    """
    try:
        # 存储到太史阁
        from agents.taishige import TaishigeAgent

        taishi_ge = TaishigeAgent(task_id="create_card_api")

        # 转换Card模型为字典
        card_dict = {
            'id': card.id,
            'type': card.type,
            'title': card.title,
            'content': card.content,
            'confidence': card.confidence,
            'tags': card.tags,
            'references': card.references
        }

        result = taishi_ge.create_card(card_dict)

        logger.info(f"创建新卡片: {result['card_id']}")

        return {
            "card_id": result['card_id'],
            "knowledge_id": result['knowledge_id'],
            "status": "created"
        }

    except Exception as e:
        logger.error(f"创建卡片失败: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/{card_id}")
async def get_card(card_id: str):
    """
    获取单个卡片详情

    从太史阁（Taishige）知识库获取卡片

    参数：
        card_id: 卡片ID

    返回：
        卡片详情
    """
    try:
        # 从太史阁获取卡片
        from agents.taishige import TaishigeAgent

        taishi_ge = TaishigeAgent(task_id="get_card_api")
        card_data = taishi_ge.get_card(card_id)

        if card_data is None:
            raise HTTPException(status_code=404, detail=f"卡片 {card_id} 未找到")

        return Card(
            id=card_data['id'],
            type=card_data['type'],
            title=card_data['title'],
            content=card_data['content'],
            confidence=card_data.get('confidence', 0.8),
            timestamp=card_data.get('timestamp', time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime())),
            tags=card_data.get('tags', []),
            references=card_data.get('references', [])
        )

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"获取卡片详情失败: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))


@router.delete("/{card_id}")
async def delete_card(card_id: str):
    """
    删除卡片

    从太史阁（Taishige）知识库删除卡片

    参数：
        card_id: 卡片ID

    返回：
        删除状态
    """
    try:
        # 从太史阁删除卡片
        from agents.taishige import TaishigeAgent

        taishi_ge = TaishigeAgent(task_id="delete_card_api")
        success = taishi_ge.delete_card(card_id)

        if not success:
            raise HTTPException(status_code=404, detail=f"卡片 {card_id} 未找到或删除失败")

        logger.info(f"删除卡片: {card_id}")

        return {
            "status": "deleted",
            "card_id": card_id
        }

    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"删除卡片失败: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=str(e))
