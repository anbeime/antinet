# Antinet 系统架构设计

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      用户界面层                              │
├─────────────────────────────────────────────────────────────┤
│  React 18 + TypeScript + Vite                               │
│  - 知识卡片管理 (四色卡片)                                   │
│  - 自然语言查询                                             │
│  - NPU 性能监控仪表板                                        │
│  - 团队协作功能                                             │
│  - GTD 任务系统                                             │
│  - 数据分析可视化                                           │
└─────────────────────┬───────────────────────────────────────┘
                      │ HTTP API (REST)
┌─────────────────────┴───────────────────────────────────────┐
│                    业务逻辑层                                │
├─────────────────────────────────────────────────────────────┤
│  FastAPI + Python 3.12                                      │
│  - API 路由处理 (/api/*)                                    │
│  - Pydantic 数据验证                                         │
│  - CORS 中间件                                               │
│  - 异步任务处理                                              │
└─────────────────────┬───────────────────────────────────────┘
                      │ QNN 推理
┌─────────────────────┴───────────────────────────────────────┐
│                    模型推理层                                │
├─────────────────────────────────────────────────────────────┤
│  QAI AppBuilder 2.31.0                                      │
│  - QNN 模型加载                                             │
│  - NPU 推理调度                                             │
│  - 性能监控                                                 │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                  硬件加速层                                 │
├─────────────────────────────────────────────────────────────┤
│  骁龙 X Elite AIPC                                         │
│  - Hexagon NPU (核心推理, 60-70%)                          │
│  - Adreno GPU (图像处理, 如需要)                            │
│  - Kryo CPU (控制逻辑, 数据预处理, ~20%)                    │
└─────────────────────────────────────────────────────────────┘
```

## 技术栈版本

| 组件 | 版本 | 用途 |
|------|------|------|
| 前端 | React 18.3.1 | UI 框架 |
| 前端 | TypeScript 5.7.2 | 类型安全 |
| 前端 | Vite 6.2.0 | 构建工具 |
| 前端 | Tailwind CSS 3.4.17 | 样式框架 |
| 前端 | Framer Motion 12.9.2 | 动画库 |
| 前端 | Recharts 2.15.1 | 数据可视化 |
| 后端 | FastAPI 0.109.0 | Web 框架 |
| 后端 | Python 3.12 | 运行时 |
| 后端 | Pydantic 2.5.3 | 数据验证 |
| 推理 | QAI AppBuilder 2.31.0 | NPU 推理 |
| 推理 | QNN SDK 2.31.0 | 模型部署 |
| 模型 | Qwen2-1.5B | 基础模型 |

## 算力分配表

| 算力单元 | 占比 | 职责 | 优势 |
|---------|------|------|------|
| **Hexagon NPU** | 60-70% | 模型推理 (Qwen2-1.5B INT8) | 低延迟、低功耗、专用算力 |
| **Kryo CPU** | ~20% | 控制逻辑、数据预处理、API 路由 | 灵活、通用、低延迟 |
| **Adreno GPU** | ~10% (可选) | 图像处理、并行计算 | 高吞吐、并行计算 |

### 算力选择理由

#### 为什么选择 NPU？

1. **性能优势**
   - 推理延迟 < 500ms (128 tokens)
   - 相比 CPU 加速 3.5x - 5.3x
   - 吞吐量: 2.2 - 8.3 QPS

2. **功耗效率**
   - 端侧低功耗运行
   - 适合长时间运行
   - 不影响其他任务

3. **体验优势**
   - 实时响应 (远快于云端)
   - 无网络延迟
   - 离线可用

4. **安全优势**
   - 数据不出域
   - 隐私保护
   - 符合合规要求

#### 算力协同

```
用户查询
    ↓
[CPU] 接收请求、解析参数 (5ms)
    ↓
[CPU] 数据预处理、Tokenization (20ms)
    ↓
[NPU] 模型推理、生成结果 (450ms)
    ↓
[CPU] 后处理、四色卡片生成 (15ms)
    ↓
[CPU] 响应组装、返回结果 (10ms)
    ↓
总耗时: ~500ms
```

## 数据流

### 1. 自然语言查询流程

```
1. 用户输入查询
   ↓
2. 前端发送 POST /api/analyze
   {
     "query": "分析上个月的销售数据趋势",
     "data_source": "local",
     "context": {}
   }
   ↓
3. 后端加载模型 (按需)
   ↓
4. NPU 推理 (450ms)
   ↓
5. 生成四色卡片
   - 蓝色 (事实): 数据统计结果
   - 绿色 (解释): 原因分析
   - 黄色 (风险): 潜在问题
   - 红色 (行动): 具体建议
   ↓
6. 返回结果
   {
     "cards": [...],
     "performance": {
       "inference_time_ms": 450,
       "device": "NPU"
     }
   }
   ↓
7. 前端展示卡片 + 性能指标
```

### 2. 性能基准测试流程

```
1. 前端调用 POST /api/performance/benchmark
   ↓
2. 后端加载模型
   ↓
3. 测试不同序列长度
   - 32 tokens: 预热 3 次, 测试 10 次
   - 64 tokens: 预热 3 次, 测试 10 次
   - 128 tokens: 预热 3 次, 测试 10 次
   - 256 tokens: 预热 3 次, 测试 10 次
   ↓
4. 计算统计指标
   - 平均延迟
   - 最小/最大延迟
   - 吞吐量 (QPS)
   ↓
5. 保存到 .benchmarks/
   ↓
6. 返回测试结果
```

### 3. 数据上传流程

```
1. 用户上传文件
   ↓
2. 前端发送 POST /api/data/upload
   {
     "file": <binary>
   }
   ↓
3. 后端验证文件大小 (< 10MB)
   ↓
4. 保存到 backend/data/uploads/
   ↓
5. 返回本地路径
   {
     "filename": "data.csv",
     "saved_path": "backend/data/uploads/data.csv",
     "data_stays_local": true
   }
   ↓
6. 强调: 数据不出域
```

## 安全设计

### 数据不出域

- ✅ 所有数据处理在本地完成
- ✅ 无云端 API 调用
- ✅ 文件上传保存到本地目录
- ✅ 配置 `DATA_STAYS_LOCAL = True`
- ✅ API 文档明确标注

### 隐私保护

- ✅ 端侧执行, 无数据传输
- ✅ 模型文件本地加载
- ✅ 不记录用户查询历史
- ✅ 不上传分析结果

## 性能指标

| 指标 | 目标 | 实测 | 验证方法 |
|------|------|------|----------|
| NPU 推理延迟 | < 500ms | ~450ms | /api/performance/benchmark |
| CPU vs NPU 加速比 | > 2x | 3.5x - 5.3x | NPU 性能监控仪表板 |
| 内存占用 | < 2GB | ~1.5GB | 系统资源监控 |
| 端到端分析时间 | < 5分钟 | ~3分钟 | 手动测试 |

## 扩展性设计

### 异构计算 (可选)

如果需要更复杂的并行计算，可以启用 GPU：

```python
# backend/config.py
QNN_BACKEND = "QNN"  # QNN | CPU | GPU
QNN_DEVICE = "NPU"   # NPU | GPU | CPU
```

GPU 将用于：
- 图像处理
- 数据可视化生成
- 并行计算任务

### 模型优化策略

1. **模型量化**
   - FP32 → INT8 (体积减小 75%)
   - 混合量化 (核心层 FP16, 普通层 INT8)

2. **输入优化**
   - 减小序列长度 (Context Length 优化)
   - 批处理 (Batch Size = 1, 端侧推荐)

3. **算子融合**
   - QNN SDK 自动优化
   - 减少内存拷贝

4. **性能模式**
   - Burst 模式 (高性能, 高功耗)
   - Power Saver 模式 (低功耗)
   - Default 模式 (平衡)

## 监控与日志

### 日志级别

- INFO: 正常运行日志
- WARNING: 性能警告 (延迟 > 500ms)
- ERROR: 错误日志

### 性能监控

- 实时延迟趋势图 (LineChart)
- CPU vs NPU 性能对比 (BarChart)
- 吞吐量 (QPS) 实时显示
- 系统健康状态 (内存/算力占用)

### 日志输出

```python
INFO - 正在加载QNN模型...
INFO - ✓ 模型加载成功 (设备: NPU)
INFO - [NPU推理] 处理查询: 分析上个月的销售数据趋势
INFO -   推理延迟: 450.23ms
INFO - 分析完成 (总耗时: 500.12ms)
INFO -   生成卡片数: 4
INFO -   NPU推理: 450.23ms
```

## 部署架构

### 开发环境

```
前端: pnpm dev (localhost:3000)
后端: python main.py (localhost:8000)
模型: 本地加载 QNN 文件
```

### 生产环境

```
前端: nginx + 静态文件
后端: gunicorn + uvicorn workers
模型: 预加载到 NPU
```

## 总结

Antinet 采用 **三层架构设计**：

1. **用户界面层**: React + TypeScript + Vite
2. **业务逻辑层**: FastAPI + Pydantic
3. **硬件加速层**: 骁龙 NPU + QNN SDK

**核心优势**:

- ✅ NPU 加速, 推理延迟 < 500ms
- ✅ 数据不出域, 隐私保护
- ✅ 四色卡片方法论, 知识沉淀
- ✅ 实时性能监控, 可视化展示
- ✅ 端侧执行, 离线可用
